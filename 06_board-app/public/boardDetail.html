<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>글 상세 보기</title>
    <link rel="stylesheet" href="./detail-styile.css" />
  </head>
  <body>
    <div class="detail-container">
      <!-- 로그인 정보 vs 작성자 정보 -->
      <div id="member_id" style="display: none"></div>
      <div id="writer_id" style="display: none"></div>
      <div class="detail-header">
        <span class="post-no">No. 123</span><span class="login"></span>
        <h2 class="post-title">bcrypt.hash()의 두 번째 인자, 10의 정체는?</h2>
        <div class="post-info">
          <span class="info-item"><strong>작성자:</strong> 관리자</span>
          <span class="info-item"
            ><strong>작성일:</strong> 2024-05-20 15:45:12</span
          >
        </div>
      </div>

      <div class="post-content">
        <!-- 실제 내용은 p 태그나 div로 구성 -->
        <p>안녕하세요. 오늘은 암호화 함수인 bcrypt에 대해 알아보겠습니다.</p>
      </div>

      <div class="btn-group">
        <button class="btn btn-list" onclick="location.href = 'boardList.html'">
          목록으로
        </button>
        <button class="btn btn-add" onclick="location.href = 'board.html'">
          등록
        </button>
        <button class="btn btn-edit">수정</button>
        <button class="btn btn-delete">삭제</button>
      </div>
    </div>
    <script>
      const page = localStorage.getItem("page");
      // ajax 호출.
      fetch("./api/board/" + page)
        .then((resp) => resp.json())
        .then(({ user, data }) => {
          console.log(data); // {user: {...}, data: [{...}]}
          const [board] = data;
          // member_id, writer_id 값 저장
          document.querySelector("#member_id").innerHTML = user.member_id;
          document.querySelector("#writer_id").innerHTML = board.writer_id;

          // 삭제버튼 비활성화 (조건 : 유저 != 작성자)
          if (user.member_id != board.writer_id) {
            document.querySelector(".btn-delete").disabled = true;
          }
          // 글내용 출력하기.
          document.querySelector("span.login").innerHTML =
            `id: ${user.login_id}(${user.name})`;
          document.querySelector(".post-no").innerHTML = "No." + board.board_id; // 글번호.
          document.querySelector(".post-title").innerHTML = board.title; // 글제목.
          // 글내용.
          document.querySelector(".post-content").innerHTML = board.content;
          // 작성자.
          document.querySelector(".info-item").innerHTML =
            `<strong>작성자:</strong> ${board.name}`;
          // 작성일시.
          document.querySelector(".post-info>span:nth-of-type(2)").innerHTML =
            `<strong>작성일:</strong> ${board.created_at}`;
        })
        .catch(console.log);

      // 삭제버튼 이벤트
      document.querySelector(".btn-delete").addEventListener("click", (e) => {
        // 삭제
        const deleteId = document
          .querySelector("span.post-no")
          .innerText.replace("No.", "");
        fetch(
          "./api/board/" + deleteId,
          {
            method: "delete",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          }
            .then((resp) => resp.json())
            .then((data) => {
              if (data.retCode == "OK") {
                alert("삭제 성공");
                location.href = "boardList.html";
              } else {
                alert("삭제 실패");
                location.reload();
              }
            }),
        );
      });

      //수정버튼 이벤트
      document.querySelector(".btn-edit").addEventListener("click", (e) => {
        // 권한 체크
        const mId = (document.querySelector("#member_id").innerHTML =
          user.member_id);
        const wId = (document.querySelector("#writer_id").innerHTML =
          board.writer_id);
        if (mId == wId) {
          alert("수정 페이지로 이동합니다.");
        } else {
          alert("권한을 확인하세요");
          return;
        }
        fetch();
      });
    </script>
  </body>
</html>
