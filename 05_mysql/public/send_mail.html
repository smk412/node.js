<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>메일 전송</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&family=DM+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./send_mail.css" />
  </head>
  <body>
    <div class="bg-grid"></div>

    <main class="container">
      <header class="header">
        <div class="header-icon">✉</div>
        <h1 class="header-title">메일 전송</h1>
        <p class="header-sub">새 메시지를 작성하고 전송하세요</p>
      </header>

      <form
        class="mail-form"
        id="mailForm"
        action="./api/mail"
        method="post"
        enctype="multipart/form-data"
      >
        <div class="form-group">
          <label class="label" for="from"
            >발신자 <span class="required">*</span></label
          >
          <div class="input-wrapper">
            <span class="input-icon">FROM</span>
            <input
              class="input"
              type="email"
              id="from"
              name="from"
              placeholder="sender@example.com"
              required
            />
          </div>
        </div>

        <div class="form-group">
          <label class="label" for="to"
            >수신자 <span class="required">*</span></label
          >
          <div class="input-wrapper">
            <span class="input-icon">TO</span>
            <input
              class="input"
              type="email"
              id="to"
              name="to"
              placeholder="receiver@example.com"
              required
            />
          </div>
        </div>

        <div class="divider"></div>

        <div class="form-group">
          <label class="label" for="subject"
            >제목 <span class="required">*</span></label
          >
          <div class="input-wrapper">
            <span class="input-icon">RE</span>
            <input
              class="input"
              type="text"
              id="subject"
              name="subject"
              placeholder="메일 제목을 입력하세요"
              required
            />
          </div>
        </div>

        <div class="form-group">
          <label class="label" for="body"
            >내용 <span class="required">*</span></label
          >
          <textarea
            class="textarea"
            id="text"
            name="text"
            placeholder="메일 내용을 입력하세요..."
            rows="10"
            required
          ></textarea>
          <div class="char-count"><span id="charCount">0</span>자</div>
        </div>

        <div class="form-group">
          <input type="file" name="myfile" />
        </div>

        <div class="form-actions">
          <button type="reset" class="btn btn-reset">초기화</button>
          <button type="submit" class="btn btn-send">
            <span class="btn-text">전송하기</span>
            <span class="btn-arrow">→</span>
          </button>
        </div>
      </form>
    </main>

    <div class="toast" id="toast">✓ 메일이 전송되었습니다!</div>

    <script>
      document //
        .querySelector("#mailForm")
        .addEventListener("submit", (e) => {
          // console.log(e);
          e.preventDefault(); // form submit 기본기능 차단
          // 필요항목
          const from = document.querySelector("#from").value;
          const to = document.querySelector("#to").value;
          const subject = document.querySelector("#subject").value;
          const text = document.querySelector("#text").value;
          if (!from || !to || !subject || !text) {
            alert("필수 항목 입력");
            return;
          }

          const formData = new FormData(); // multipart 요청.
          formData.append("from", from);
          formData.append("to", to);
          formData.append("subject", subject);
          formData.append("text", text);
          formData.append("myfile", e.target[4].files[0]);

          fetch("./api/mail", {
            method: "post",
            // headers: { "Content-Type": "application/json" },
            body: formData,
          })
            .then((resp) => resp.json())
            .then((data) => {
              console.log(data);
              if (data.retCode == "OK") {
                alert("메일발송");
                location.reload();
              } else {
                alert("발송실패");
              }
            })
            .catch((err) => console.log(err)); // form 기능 그대로 쓰기로 하면서 나는  서버 500 오류 막기위해 fetch 주석처리
        });

      const textarea = document.getElementById("body");
      const charCount = document.getElementById("charCount");
      // textarea.addEventListener("input", () => {
      //   charCount.textContent = textarea.value.length;
      // });

      const form = document.getElementById("mailForm");
      const toast = document.getElementById("toast");
      form.addEventListener("submit", (e) => {
        // e.preventDefault();
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 3000);
        // form.reset();
        charCount.textContent = "0";
      });
    </script>
  </body>
</html>
